<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vibe Test Suite</title>
    </head>
    <body>
        <script type="text/javascript" src="vibe.js"></script>
        <script type="text/javascript">
        var sessionId;
        var crossOrigin = location.search === "?crossorigin"
        
        window.begin = function(sid) {
            sessionId = vibe.util.parseJSON(sid);
            (function poll() {
                var script = document.createElement("script"),
                    head = document.head || document.getElementsByTagName("head")[0] || document.documentElement;
                
                script.async = true;
                script.src = "/poll?sid=" + sessionId + "&_=" + Math.random();
                script.onload = script.onreadystatechange = function() {
                    if (!script.readyState || /loaded|complete/.test(script.readyState)) {
                        // Needed in Internet Explorer 8 and 9 when testing cross origin connection
                        script.onload = script.onreadystatechange = null;
                        if (script.parentNode) {
                            script.parentNode.removeChild(script);
                        }
                        if (!window.mochaResults) {
                            poll();
                        }
                    }
                };
                head.insertBefore(script, head.firstChild);
            })();
        };
        window.end = function(text) {
            window.mochaResults = vibe.util.parseJSON(text);
        };
        
        var socket;
        window.connect = function(text) {
            if (socket) {
                socket.close();
            }
            var params = vibe.util.parseJSON(text);
            socket = vibe.open((crossOrigin ? params.uri : "/vibe") + "?sid=" + sessionId, {
                transports: [params.transport], 
                heartbeat: +params.heartbeat || false, 
                _heartbeat: +params._heartbeat || false, 
                reconnect: false, 
                xdrURL: function(url) {
                    return url;
                }
            })
            .on("abort", function() {
                this.close();
            })
            .on("echo", function(data) {
                var self = this;
                // To mitigate stress
                setTimeout(function() {
                    self.send("echo", data);
                }, 10);
            })
            .on("rre.resolve", function(data, reply) {
                reply.resolve(data);
            })
            .on("rre.reject", function(data, reply) {
                reply.reject(data);
            })
            .on("sre.resolve", function(data) {
                this.send("sre.resolve", data, function(data) {
                    this.send("sre.done", data);
                });
            })
            .on("sre.reject", function(data) {
                this.send("sre.reject", data, null, function(data) {
                    this.send("sre.done", data);
                });
            });
        };
        window.onload = function() {
            var browser = (function() {
                var ua = navigator.userAgent.toLowerCase(),
                    browser = {},
                    match = /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(ua) ||
                        /(msie) ([\w.]+)/.exec(ua) ||
                        /(trident)(?:.*? rv:([\w.]+)|)/.exec(ua) || 
                        ua.indexOf("android") < 0 && /version\/(.+) (safari)/.exec(ua) ||
                        ua.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(ua) || [];

                if (match[2] === "safari") {
                    match[0] = match[2];
                    match[2] = match[1];
                    match[1] = match[0];
                }
                
                // There is no Version/6.0 and Safari/8536.25 part in user agent string of iOS 6 emulator
                if (/(?:iphone|ipad).*os 6_/.test(ua)) {
                    match = ["", "safari", "6.x"];
                }

                browser[match[1] || ""] = true;
                browser.version = match[2] || "0";

                if (browser.trident) {
                    browser.msie = true;
                }
                
                browser.vmajor = +browser.version.split(".")[0];
                return browser;
            })();
            
            var transports = [];
            if (window.WebSocket &&
                // Proxy lib doesn't seem to support Safari 5's WebSocket protocol, hixie-76
                (!browser.safari || browser.vmajor >= 6 || crossOrigin)) {
                transports.push("ws");
            }
            if (window.EventSource && 
                (!browser.safari || !crossOrigin || browser.vmajor >= 7)) {
                transports.push("sse");
            }
            if (window.XDomainRequest) {
                transports.push("streamxdr");
            }
            if ((!crossOrigin || vibe.util.corsable) && 
                (!browser.msie || browser.vmajor >= 10) && 
                (!browser.opera || browser.vmajor >= 13)) {
                transports.push("streamxhr");
            }
            if (window.ActiveXObject && !crossOrigin) {
                try {
                    !!new ActiveXObject("htmlfile");
                    transports.push("streamiframe");
                } catch (e) {}
            }
            if (!crossOrigin || vibe.util.corsable) {
                transports.push("longpollajax");
            }
            if (window.XDomainRequest) {
                transports.push("longpollxdr");
            }
            transports.push("longpolljsonp");
            
            var script = document.createElement("script"),
                head = document.head || document.getElementsByTagName("head")[0] || document.documentElement;
            
            script.async = true;
            script.src = "/begin?transports=" + encodeURIComponent(transports.join("|"));
            script.onload = script.onreadystatechange = function() {
                if (!script.readyState || /loaded|complete/.test(script.readyState)) {
                    // Needed in Internet Explorer 8 and 9 when testing cross origin connection
                    script.onload = script.onreadystatechange = null;
                    if (script.parentNode) {
                        script.parentNode.removeChild(script);
                    }
                }
            };
            head.insertBefore(script, head.firstChild);
        };
        </script>
    </body>
</html>