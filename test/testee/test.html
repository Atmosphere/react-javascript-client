<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Vibe Test Suite</title>
    </head>
    <body>
        <script type="text/javascript" src="vibe.js"></script>
        <script type="text/javascript">        
        function setMochaResults(text) {
            window.mochaResults = vibe.util.parseJSON(text);
        }
        
        function poll(sid) {
            var script = document.createElement("script"),
                head = document.head || document.getElementsByTagName("head")[0] || document.documentElement;
            
            script.async = true;
            script.src = "http://localhost:9000/poll?sid=" + sid + "&_=" + Math.random();
            script.clean = function() {
                script.clean = script.onerror = script.onload = script.onreadystatechange = null;
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };
            script.onload = script.onreadystatechange = function() {
                if (!script.readyState || /loaded|complete/.test(script.readyState)) {
                    if (script.clean) {
                        script.clean();
                    }
                    if (!window.mochaResults) {
                        poll(sid);
                    }
                }
            };
            head.insertBefore(script, head.firstChild);
        }
        
        var socket;
        function connect(text) {
            if (socket) {
                socket.close();
            }
            
            var params = vibe.util.parseJSON(text);
            socket = vibe.open(params.uri.replace("localhost", "127.0.0.1"), {
                transports: [params.transport], 
                heartbeat: +params.heartbeat || false, 
                _heartbeat: +params._heartbeat || false, 
                reconnect: false, 
                xdrURL: function(url) {
                    return url;
                }
            })
            .on("abort", function() {
                this.close();
            })
            .on("echo", function(data) {
                this.send("echo", data);
            })
            .on("replyable", function(bool, reply) {
                if (bool) {
                    reply.resolve(bool);
                } else {
                    reply.reject(bool);
                }
            });
        }
        
        (function() {
            var crossOrigin = location.search === "?crossorigin"
            var transports = [];
            
            if (window.WebSocket) {
                transports.push("ws");
            }
            if (window.EventSource) {
                transports.push("sse");
            }
            if (window.XDomainRequest) {
                transports.push("streamxdr");
            }
            if ((!vibe.util.browser.msie || (+vibe.util.browser.version.split(".")[0] >= 10)) && 
                    (!crossOrigin || vibe.util.corsable)) {
                transports.push("streamxhr");
            }
            if (window.ActiveXObject && !crossOrigin) {
                try {
                    !!new ActiveXObject("htmlfile");
                    transports.push("streamiframe");
                } catch (e) {}
            }
            if (!crossOrigin || vibe.util.corsable) {
                transports.push("longpollajax");
            }
            if (window.XDomainRequest) {
                transports.push("longpollxdr");
            }
            transports.push("longpolljsonp");
            
            var script = document.createElement("script"),
                head = document.head || document.getElementsByTagName("head")[0] || document.documentElement;
            
            script.async = true;
            script.src = "/start?transports=" + encodeURIComponent(transports.join("|"));
            script.clean = function() {
                script.clean = script.onerror = script.onload = script.onreadystatechange = null;
                if (script.parentNode) {
                    script.parentNode.removeChild(script);
                }
            };
            script.onload = script.onreadystatechange = function() {
                if (!script.readyState || /loaded|complete/.test(script.readyState)) {
                    if (script.clean) {
                        script.clean();
                    }
                }
            };
            head.insertBefore(script, head.firstChild);
        })();
        </script>
    </body>
</html>